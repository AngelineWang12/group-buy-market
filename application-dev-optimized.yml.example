# 性能优化后的开发环境配置示例
# 基于压测结果分析，针对锁单接口性能瓶颈进行的配置优化

server:
  port: 8091
  # 优化说明：根据压测结果，高并发时TPS达到481.6/s，需要增加Tomcat线程和连接数
  # 建议配置（针对4核8G服务器）：
  # - max-threads: 200-400（根据CPU核心数调整，一般为核心数*100）
  # - max-connections: 10000（足够应对高并发）
  # - accept-count: 1000（等待队列，防止连接被拒绝）
  tomcat:
    mbeanregistry:
      enabled: true
    max-connections: 10000  # 优化：从20增加到10000，支持高并发
    threads:
      max: 200              # 优化：从20增加到200，提升并发处理能力
      min-spare: 50         # 优化：从10增加到50，减少线程创建开销
    accept-count: 1000      # 优化：从10增加到1000，增加等待队列长度

# 线程池配置
thread:
  pool:
    executor:
      config:
        core-pool-size: 50      # 优化：从20增加到50
        max-pool-size: 200      # 优化：从50增加到200
        keep-alive-time: 5000
        block-queue-size: 5000
        policy: CallerRunsPolicy

# 数据库配置；启动时配置数据库资源信息
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://127.0.0.1:13306/group_buy_market?useUnicode=true&characterEncoding=utf8&autoReconnect=true&zeroDateTimeBehavior=convertToNull&serverTimezone=Asia/Shanghai&useSSL=true&sessionVariables=sql_mode='NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES'
    driver-class-name: com.mysql.cj.jdbc.Driver
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      pool-name: Retail_HikariCP
      # ⚠️ 关键优化：数据库连接池配置
      # 压测结果显示在高并发（TPS 481.6/s）时连接池成为瓶颈
      minimum-idle: 30          # 优化：从15增加到30，保持更多空闲连接
      idle-timeout: 180000      # 空闲连接存活最大时间，默认600000（10分钟）
      maximum-pool-size: 100    # ⚠️ 关键优化：从25增加到100，应对高并发场景
      auto-commit: true
      max-lifetime: 1800000     # 连接最长生命周期，30分钟
      connection-timeout: 60000 # ⚠️ 关键优化：从30000增加到60000，避免连接获取超时
      connection-test-query: SELECT 1
      # 可选：添加连接池监控
      register-mbeans: true     # 启用JMX监控，可以通过JConsole等工具监控连接池状态
      leak-detection-threshold: 60000  # 连接泄漏检测阈值（60秒），帮助发现连接泄漏问题
      
  # RabbitMQ配置保持不变
  rabbitmq:
    addresses: 172.16.0.24
    port: 5672
    username: appuser
    password: app123456
    virtual-host: /
    listener:
      simple:
        prefetch: 1
    template:
      delivery-mode: persistent
    config:
      producer:
        exchange: group_buy_market_exchange
        topic_team_success:
          routing_key: topic.team_success
          queue: group_buy_market_queue_2_topic_team_success
        topic_team_refund:
          routing_key: topic.team_refund
          queue: group_buy_market_queue_2_topic_team_refund
        topic_market_rank:
          routing_key: topic.market_rank
          queue: group_buy_market_queue_2_topic_market_rank

# MyBatis配置保持不变
mybatis:
  mapper-locations: classpath:/mybatis/mapper/*.xml
  config-location: classpath:/mybatis/config/mybatis-config.xml

# Redis配置优化
redis:
  sdk:
    config:
      host: redis
      port: 16379
      pool-size: 20             # 优化：从10增加到20，支持更多并发Redis操作
      min-idle-size: 10         # 优化：从5增加到10
      idle-timeout: 30000
      connect-timeout: 5000
      retry-attempts: 3
      retry-interval: 1000
      ping-interval: 60000
      keep-alive: true

# 扳手工程配置保持不变
xfg:
  wrench:
    config:
      system: group-buy-market
      register:
        host: 172.16.0.24
        port: 16379

# 日志配置保持不变
logstash:
  host: 172.16.0.24

# 监控配置 - 保持启用，便于性能监控
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
  prometheus:
    enabled: true

# 日志配置 - 优化：减少生产日志，提升性能
logging:
  level:
    root: info
    # 优化：将部分频繁打印的日志调整为DEBUG级别，减少IO开销
    cn.bugstack.domain.trade.service.lock.filter: debug  # 交易规则过滤日志
    cn.bugstack.domain.trade.service.lock: info
    cn.bugstack.trigger.http: info
  config: classpath:logback-spring.xml

# ============================================================================
# 优化说明总结
# ============================================================================
# 
# 1. 数据库连接池优化（最关键）
#    - maximum-pool-size: 25 → 100 (提升4倍)
#    - minimum-idle: 15 → 30 (提升2倍)
#    - connection-timeout: 30000 → 60000 (提升2倍)
#    - 预期效果：减少连接等待时间，降低错误率
#
# 2. Tomcat线程配置优化
#    - max-threads: 20 → 200 (提升10倍)
#    - max-connections: 20 → 10000 (提升500倍)
#    - accept-count: 10 → 1000 (提升100倍)
#    - 预期效果：支持更高并发，减少请求排队
#
# 3. Redis连接池优化
#    - pool-size: 10 → 20 (提升2倍)
#    - 预期效果：提升Redis操作并发能力
#
# 4. 日志级别优化
#    - 将频繁打印的业务日志调整为DEBUG
#    - 预期效果：减少IO开销，提升响应速度
#
# 注意事项：
# 1. 这些配置需要根据实际服务器资源（CPU、内存）进行调整
# 2. 数据库连接池大小不应超过数据库最大连接数限制
# 3. 建议先在测试环境验证，确认无问题后再应用到生产环境
# 4. 配置调整后需要重启应用才能生效
# 5. 建议配合监控工具观察优化效果
#
